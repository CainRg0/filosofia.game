<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>La Scuola di Atene - Tema Filosofia</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      background: #0a1a3f; /* blu scuro */
      color: white;
      font-family: sans-serif;
    }
    canvas {
      display: block;
      margin: auto;
    }
    /* overlay menu */
    #menu-overlay {
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
    }
    #menu-box {
      background: #0d1f35; /* blu scuro menu */
      padding: 26px;
      border-radius: 10px;
      text-align:center;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
    }
    #menu-box h1 { margin: 0 0 8px 0; font-size: 28px; }
    #menu-box p { margin: 0 0 16px 0; color: #9fb0c6; }
    #start-btn {
      background:#1a73e8;
      color:#fff;
      border:none;
      padding:10px 18px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
    }
    .info-bottom {
      position: fixed;
      left: 10px;
      bottom: 10px;
      color:#ddd;
      font-size:12px;
    }
  </style>
</head>
<body>
  <!-- Menu iniziale -->
  <div id="menu-overlay">
    <div id="menu-box">
      <h1>La Scuola di Atene</h1>
      <p>Premi START per iniziare il gioco</p>
      <button id="start-btn">START</button>
    </div>
  </div>

  <script>
    class MainScene extends Phaser.Scene {
      constructor() { super('MainScene'); }

      preload() {
        this.load.image('platone', 'img/platone.png');
        this.load.image('aristotele', 'img/aristotele.png');
        this.load.image('galileo', 'img/galileo.png');
        this.load.image('player', 'img/player.png');
      }

      create() {
        const W = this.sys.game.config.width;
        const H = this.sys.game.config.height;

        this.bgGraphics = this.add.graphics().setDepth(-10);
        this.quoteTexts = [];
        const quotes = [
          { t: 'La virtù sta nel giusto mezzo.', a: 'Aristotele' },
          { t: 'Conosci te stesso.', a: 'Platone' },
          { t: 'Eppur si muove.', a: 'Galileo' },
          { t: 'La sapienza comincia nella meraviglia.', a: 'Platone' },
          { t: 'La ragione è la migliore guida.', a: 'Aristotele' }
        ];

        for (let i = 0; i < 6; i++) {
          const q = quotes[i % quotes.length];
          const txt = this.add.text(
            Phaser.Math.Between(20, W-20),
            Phaser.Math.Between(H+20, H+300),
            `${q.t} — ${q.a}`,
            { fontSize: '16px', fill: '#cfc5a8', fontStyle: 'italic' }
          ).setDepth(-5);
          txt.speed = Phaser.Math.FloatBetween(10, 40);
          txt.spin = Phaser.Math.FloatBetween(-0.008, 0.008);
          this.quoteTexts.push(txt);
        }

        this.decorGraphics = this.add.graphics().setDepth(-9);

        this.player = this.physics.add.sprite(100, 200, 'player').setScale(0.5);
        this.physics.world.setBounds(0, 0, 800, 400);
        this.player.setCollideWorldBounds(true);

        this.philosophers = this.physics.add.staticGroup();
        this.platone = this.philosophers.create(300, 150, 'platone').setScale(0.2);
        this.aristotele = this.philosophers.create(500, 250, 'aristotele').setScale(0.2);
        this.galileo = this.philosophers.create(700, 150, 'galileo').setScale(0.2);

        this.cursors = this.input.keyboard.createCursorKeys();

        this.dialogBg = this.add.rectangle(400, 350, 780, 90, 0x0a1a3f, 0.7).setScrollFactor(0).setVisible(false).setDepth(10);
        this.dialogBox = this.add.text(20, 320, '', {
          fontSize: '16px', fill: '#fff', wordWrap: { width: 760 }
        }).setScrollFactor(0).setVisible(false).setDepth(11);

        this.statusText = this.add.text(600, 20, '', { fontSize: '16px', fill: '#fff' }).setScrollFactor(0).setDepth(11);

        this.dialogActive = false;
        this.currentPhilosopher = null;
        this.gameFinished = false;
        this.recentlyInteracted = { platone: false, aristotele: false, galileo: false };
        this.awaitingAnswer = false;

        this.input.keyboard.on('keydown-V', () => {
          if (!this.dialogActive || !this.awaitingAnswer || this.gameFinished) return;
          this.handleAnswer(true);
        });
        this.input.keyboard.on('keydown-F', () => {
          if (!this.dialogActive || !this.awaitingAnswer || this.gameFinished) return;
          this.handleAnswer(false);
        });
        this.input.keyboard.on('keydown-SPACE', () => {
          if (this.gameFinished) return;
          if (this.dialogActive && this.quizIndex === -1) {
            this.quizIndex = 0;
            this.showQuestion();
          }
        });
        this.input.keyboard.on('keydown-R', () => {
          if (this.gameFinished) { this.scene.restart(); }
        });

        this.quizData = {
          platone: {
            intro: "Ciao! Sono Platone. Filosofo delle Idee. Vuoi fare un test?",
            questions: [
              { q: "Il mondo sensibile è più importante delle idee?", a: false },
              { q: "Platone ha scritto la Repubblica?", a: true },
              { q: "Platone è stato maestro di Aristotele?", a: true }
            ]
          },
          aristotele: {
            intro: "Salve! Sono Aristotele. Amo osservare la realtà. Facciamo un quiz!",
            questions: [
              { q: "Aristotele era allievo di Platone?", a: true },
              { q: "Per Aristotele la virtù sta nel giusto mezzo?", a: true },
              { q: "Aristotele era un filosofo medievale?", a: false }
            ]
          },
          galileo: {
            intro: "Sono Galileo Galilei. Studio il cielo con il mio telescopio. Pronto a verificare le idee?",
            questions: [
              { q: "Galileo osservò le lune di Giove con il telescopio?", a: true },
              { q: "Galileo fu processato per le sue scoperte astronomiche?", a: true },
              { q: "Galileo era contemporaneo di Platone?", a: false }
            ]
          }
        };

        this.quizIndex = 0;
        this.score = 0;
        this.completedTests = { platone: false, aristotele: false, galileo: false };
        this.updateStatus();
        this.bgStart = this.time.now;
      }

      update(time, delta) {
        this.drawPhilosophyBackground(time);

        if (this.dialogActive || this.gameFinished) {
          this.player.setVelocity(0);
          this.updateQuoteTexts(delta);
          return;
        }

        const speed = 150;
        this.player.setVelocity(0);
        if (this.cursors.left.isDown) this.player.setVelocityX(-speed);
        if (this.cursors.right.isDown) this.player.setVelocityX(speed);
        if (this.cursors.up.isDown) this.player.setVelocityY(-speed);
        if (this.cursors.down.isDown) this.player.setVelocityY(speed);

        if (!this.dialogActive && !this.gameFinished) {
          if (Phaser.Math.Distance.BetweenPoints(this.player, this.platone) < 50 && !this.recentlyInteracted.platone) {
            this.startDialog('platone');
          }
          if (Phaser.Math.Distance.BetweenPoints(this.player, this.aristotele) < 50 && !this.recentlyInteracted.aristotele) {
            this.startDialog('aristotele');
          }
          if (Phaser.Math.Distance.BetweenPoints(this.player, this.galileo) < 50 && !this.recentlyInteracted.galileo) {
            this.startDialog('galileo');
          }
        }
        this.updateQuoteTexts(delta);
      }

      drawPhilosophyBackground(time) {
        const g = this.bgGraphics;
        g.clear();
        const W = this.sys.game.config.width;
        const H = this.sys.game.config.height;
        const t = (time - this.bgStart) / 1000;

        g.fillStyle(0x0a1a3f, 1); // blu scuro principale
        g.fillRect(0,0,W,H);

        g.fillStyle(0x123357, 0.06); // overlay blu
        g.fillRect(0,0,W,H);

        g.fillStyle(0x1f2933, 0.08);
        for (let i = 0; i < 4; i++) {
          const x = 80 + i * 220 + Math.sin(t*0.3 + i) * 6;
          g.fillRect(x, 20, 40, H-60);
        }

        g.lineStyle(2, 0x6b8a3d, 0.06);
        for (let i = 0; i < 3; i++) {
          const cx = 150 + i*280;
          const cy = 70;
          g.beginPath();
          g.arc(cx + Math.sin(t*0.4 + i)*6, cy + Math.cos(t*0.6 + i)*4, 36, Phaser.Math.DegToRad(180), Phaser.Math.DegToRad(360));
          g.strokePath();
        }

        g.lineStyle(1, 0x4a3e2b, 0.03);
        for (let y = 0; y < H; y += 26) {
          g.beginPath();
          g.moveTo(0, y + Math.sin((t*0.4 + y)*0.02)*3);
          g.lineTo(W, y + Math.sin((t*0.4 + y)*0.02)*3);
          g.strokePath();
        }

        for (let k = 0; k < 14; k++) {
          const px = (k * 97 + (t*30)) % W;
          const py = 40 + ((k*37) % (H-80)) + Math.sin((px + t*20) * 0.02) * 6;
          g.fillStyle(0xf7e7c4, 0.06);
          g.fillCircle(px, py, 2);
        }
      }

      updateQuoteTexts(delta) {
        const W = this.sys.game.config.width;
        const H = this.sys.game.config.height;
        this.quoteTexts.forEach(t => {
          t.y -= t.speed * (delta/1000);
          t.rotation += t.spin * (delta/1000);
          t.alpha = 0.4 + Math.abs(Math.sin((t.y + Date.now()/1000) * 0.4)) * 0.6;
          if (t.y < -40) {
            t.y = H + Phaser.Math.Between(20, 200);
            t.x = Phaser.Math.Between(20, W-20);
          }
        });
      }

      // metodi quiz (invariati) ...
      startDialog(name) {
        this.player.setVelocity(0);
        this.dialogActive = true;
        this.currentPhilosopher = name;
        this.dialogBg.setVisible(true);
        this.dialogBox.setVisible(true).setText(this.quizData[name].intro + "\n(Premi SPAZIO)");
        this.quizIndex = -1;
        this.score = 0;
        this.awaitingAnswer = false;
      }
      showQuestion() {
        const current = this.quizData[this.currentPhilosopher].questions[this.quizIndex];
        if (!current) return;
        this.dialogBox.setText(current.q + "\nRispondi: V (vero) / F (falso)");
        this.awaitingAnswer = true;
      }
      handleAnswer(givenTrue) {
        const current = this.quizData[this.currentPhilosopher].questions[this.quizIndex];
        if (!current) { this.awaitingAnswer = false; return; }
        if (current.a === givenTrue) this.score++;
        this.awaitingAnswer = false;
        this.quizIndex++;
        this.showQuestionOrEnd();
      }
      showQuestionOrEnd() {
        if (this.quizIndex < this.quizData[this.currentPhilosopher].questions.length) {
          this.showQuestion();
        } else { this.endQuiz(); }
      }
      endQuiz() {
        const total = this.quizData[this.currentPhilosopher].questions.length;
        if (this.score === total) {
          this.dialogBox.setText("Congratulazioni, hai passato il test con " + this.currentPhilosopher + "!");
          this.completedTests[this.currentPhilosopher] = true;
          this.updateStatus();
        } else {
          this.dialogBox.setText("Mi dispiace, non hai passato il test con " + this.currentPhilosopher + ". Riprova!");
        }
        if (this.completedTests.platone && this.completedTests.aristotele && this.completedTests.galileo) {
          this.dialogBox.setText("Hai superato tutti i test dei filosofi!\n🎉 Congratulazioni, hai completato il gioco!\nPremi R per ricominciare.");
          this.gameFinished = true;
          return;
        }
        this.time.delayedCall(2000, () => { if (!this.gameFinished) this.closeDialog(); });
      }
      closeDialog() {
        if (this.gameFinished) return;
        if (!this.currentPhilosopher) return;
        const name = this.currentPhilosopher;
        this.dialogActive = false;
        this.dialogBg.setVisible(false);
        this.dialogBox.setVisible(false);
        const dx = this.player.x - this[name].x;
        const dy = this.player.y - this[name].y;
        const len = Math.sqrt(dx * dx + dy * dy) || 1;
        this.player.x += (dx / len) * 20;
        this.player.y += (dy / len) * 20;
        this.recentlyInteracted[name] = true;
        this.time.delayedCall(800, () => { this.recentlyInteracted[name] = false; });
        this.currentPhilosopher = null;
      }
      updateStatus() {
        this.statusText.setText(
          `Platone: ${this.completedTests.platone ? "✓" : "✗"}\n` +
          `Aristotele: ${this.completedTests.aristotele ? "✓" : "✗"}\n` +
          `Galileo: ${this.completedTests.galileo ? "✓" : "✗"}`
        );
      }
    }

    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 400,
      backgroundColor: '#0a1a3f', // blu scuro anche qui
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: [MainScene]
    };

    window.startGame = function() {
      if (!window.__GAME__) {
        window.__GAME__ = new Phaser.Game(config);
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      const startBtn = document.getElementById('start-btn');
      const overlay = document.getElementById('menu-overlay');
      startBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
        window.startGame();
      });
    });
  </script>

  <div class="info-bottom">
    Controlli: Frecce / V-F per vero/falso / A-C per scelta multipla. Su mobile: usa i bottoni in basso.
  </div>
</body>
</html>
