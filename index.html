<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>La Scuola di Atene - Mini Gioco</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; }
    canvas { display: block; margin: auto; }
  </style>
</head>
<body>
<script>
class MainScene extends Phaser.Scene {
  constructor() { super('MainScene'); }

  preload() {
    this.load.image('platone', 'img/platone.png');
    this.load.image('aristotele', 'img/aristotele.png');
    this.load.image('diogene', 'img/diogene.png');
    this.load.image('player', 'img/player.png');
  }

  create() {
    this.player = this.physics.add.sprite(100, 200, 'player').setScale(0.5);
	this.physics.world.setBounds(0, 0, 800, 400); 
    this.player.setCollideWorldBounds(true);
    this.philosophers = this.physics.add.staticGroup();
    this.platone = this.philosophers.create(300, 150, 'platone').setScale(0.2);
    this.aristotele = this.philosophers.create(500, 250, 'aristotele').setScale(0.2);
    this.diogene = this.philosophers.create(700, 150, 'diogene').setScale(0.2);

    this.cursors = this.input.keyboard.createCursorKeys();

    // dialog UI
    this.dialogBg = this.add.rectangle(400, 350, 780, 90, 0x000000, 0.7).setScrollFactor(0).setVisible(false);
    this.dialogBox = this.add.text(20, 320, '', { fontSize: '16px', fill: '#fff', wordWrap: { width: 760 } }).setScrollFactor(0).setVisible(false);

    // contatore test completati
    this.statusText = this.add.text(600, 20, '', { fontSize: '16px', fill: '#fff' }).setScrollFactor(0);

    // stato
    this.dialogActive = false;
    this.currentPhilosopher = null;
    this.gameFinished = false;
    this.recentlyInteracted = { platone: false, aristotele: false, diogene: false };

    // gestione "risposte"
    this.awaitingAnswer = false;
    // Unico listener globale per V/F: usa awaitingAnswer per decidere se processare
    this.input.keyboard.on('keydown-V', () => {
      if (!this.dialogActive || !this.awaitingAnswer || this.gameFinished) return;
      this.handleAnswer(true);
    });
    this.input.keyboard.on('keydown-F', () => {
      if (!this.dialogActive || !this.awaitingAnswer || this.gameFinished) return;
      this.handleAnswer(false);
    });

    // SPACE per partire dal dialog intro alla prima domanda (solo se siamo in stato intro)
    this.input.keyboard.on('keydown-SPACE', () => {
      if (this.gameFinished) return;
      if (this.dialogActive && this.quizIndex === -1) {
        this.quizIndex = 0;
        this.showQuestion();
      }
    });

    // R per restart quando gameFinished
    this.input.keyboard.on('keydown-R', () => {
      if (this.gameFinished) {
        this.scene.restart();
      }
    });

    this.quizData = {
      platone: {
        intro: "Ciao! Sono Platone. Filosofo delle Idee. Vuoi fare un test?",
        questions: [
          { q: "Il mondo sensibile Ã¨ piÃ¹ importante delle idee?", a: false },
          { q: "Platone ha scritto la Repubblica?", a: true },
          { q: "Platone Ã¨ stato maestro di Aristotele?", a: true }
        ]
      },
      aristotele: {
        intro: "Salve! Sono Aristotele. Amo osservare la realtÃ . Facciamo un quiz!",
        questions: [
          { q: "Aristotele ha studiato con Platone?", a: true },
          { q: "Per Aristotele la virtÃ¹ sta nel giusto mezzo?", a: true },
          { q: "Aristotele era un filosofo medievale?", a: false }
        ]
      },
      diogene: {
        intro: "Ehi! Io sono Diogene, il cinico. Vivi con poco! Sei pronto?",
        questions: [
          { q: "Diogene viveva in una botte?", a: true },
          { q: "Diogene amava i beni materiali?", a: false },
          { q: "Diogene cercava l'uomo con una lanterna?", a: true }
        ]
      }
    };

    this.quizIndex = 0;
    this.score = 0;
    this.completedTests = { platone: false, aristotele: false, diogene: false };
    this.updateStatus();
  }

  update() {
    if (this.dialogActive || this.gameFinished) {
      this.player.setVelocity(0);
      return;
    }

    const speed = 150;
    this.player.setVelocity(0);
    if (this.cursors.left.isDown) this.player.setVelocityX(-speed);
    if (this.cursors.right.isDown) this.player.setVelocityX(speed);
    if (this.cursors.up.isDown) this.player.setVelocityY(-speed);
    if (this.cursors.down.isDown) this.player.setVelocityY(speed);

    if (!this.dialogActive && !this.gameFinished) {
      if (Phaser.Math.Distance.BetweenPoints(this.player, this.platone) < 50 && !this.recentlyInteracted.platone) {
        this.startDialog('platone');
      }
      if (Phaser.Math.Distance.BetweenPoints(this.player, this.aristotele) < 50 && !this.recentlyInteracted.aristotele) {
        this.startDialog('aristotele');
      }
      if (Phaser.Math.Distance.BetweenPoints(this.player, this.diogene) < 50 && !this.recentlyInteracted.diogene) {
        this.startDialog('diogene');
      }
    }
  }

  startDialog(name) {
    this.player.setVelocity(0);
    this.dialogActive = true;
    this.currentPhilosopher = name;
    this.dialogBg.setVisible(true);
    this.dialogBox.setVisible(true).setText(this.quizData[name].intro + "\n(Premi SPAZIO)");
    this.quizIndex = -1;
    this.score = 0;
    this.awaitingAnswer = false;
  }

  showQuestion() {
    const current = this.quizData[this.currentPhilosopher].questions[this.quizIndex];
    if (!current) return;
    this.dialogBox.setText(current.q + "\nRispondi: V (vero) / F (falso)");
    this.awaitingAnswer = true;
  }

  handleAnswer(givenTrue) {
    // protezione: se non c'Ã¨ domanda corrente, ignora
    const current = this.quizData[this.currentPhilosopher].questions[this.quizIndex];
    if (!current) { this.awaitingAnswer = false; return; }

    if (current.a === givenTrue) this.score++;
    this.awaitingAnswer = false;
    this.quizIndex++;
    this.showQuestionOrEnd();
  }

  showQuestionOrEnd() {
    if (this.quizIndex < this.quizData[this.currentPhilosopher].questions.length) {
      this.showQuestion();
    } else {
      this.endQuiz();
    }
  }

  endQuiz() {
    const total = this.quizData[this.currentPhilosopher].questions.length;
    if (this.score === total) {
      this.dialogBox.setText("Congratulazioni, hai passato il test con " + this.currentPhilosopher + "!");
      this.completedTests[this.currentPhilosopher] = true;
      this.updateStatus();
    } else {
      this.dialogBox.setText("Mi dispiace, non hai passato il test con " + this.currentPhilosopher + ". Riprova!");
    }

    // Se sono completati tutti i test: mostra messaggio FINALE e NON chiudere automaticamente
    if (this.completedTests.platone && this.completedTests.aristotele && this.completedTests.diogene) {
      this.dialogBox.setText("Hai superato tutti i test dei filosofi!\nðŸŽ‰ Congratulazioni, hai completato il gioco!\nPremi R per ricominciare.");
      this.gameFinished = true;
      // Resta visibile fino a R pressato
      return;
    }

    // Altrimenti chiudi automaticamente dopo 2 secondi (per permettere di vedere il risultato)
    this.time.delayedCall(2000, () => {
      // se nel frattempo il gioco Ã¨ diventato finished, non chiudere
      if (this.gameFinished) return;
      this.closeDialog();
    });
  }

  closeDialog() {
    // se il gioco Ã¨ finito, non chiudere la finestra finale
    if (this.gameFinished) return;

    if (!this.currentPhilosopher) return;
    const name = this.currentPhilosopher;

    this.dialogActive = false;
    this.dialogBg.setVisible(false);
    this.dialogBox.setVisible(false);

    // piccolo "rimbalzo" del player indietro per evitare ri-trigger
    const dx = this.player.x - this[name].x;
    const dy = this.player.y - this[name].y;
    const len = Math.sqrt(dx * dx + dy * dy) || 1;
    this.player.x += (dx / len) * 20;
    this.player.y += (dy / len) * 20;

    this.recentlyInteracted[name] = true;
    this.time.delayedCall(800, () => {
      this.recentlyInteracted[name] = false;
    });

    this.currentPhilosopher = null;
  }

  updateStatus() {
    this.statusText.setText(
      `Platone: ${this.completedTests.platone ? "âœ“" : "âœ—"}\n` +
      `Aristotele: ${this.completedTests.aristotele ? "âœ“" : "âœ—"}\n` +
      `Diogene: ${this.completedTests.diogene ? "âœ“" : "âœ—"}`
    );
  }
}

const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 400,
  backgroundColor: '#555',
  physics: { default: 'arcade', arcade: { debug: false } },
  scene: [MainScene]
};

new Phaser.Game(config);
</script>


<audio id="bg-music" autoplay loop>
  <source src="On the Nature of Daylight.mp3" type="audio/mpeg">
</audio>

<script>
  const music = document.getElementById("bg-music");
  document.addEventListener("click", () => {
    if (music.paused) music.play();
  });
</script>
</body>
</html>
